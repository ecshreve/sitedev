---
layout: post
title: droplet
tags: terraform devops digitalocean
---

## Summary

Quick rundown of how to create a droplet on DigitalOcean using Terraform.

## Prerequisites

- [Terraform](https://www.terraform.io/downloads.html) installed.
- [DigitalOcean](https://www.digitalocean.com/) account.
- [Personal Access Token](https://cloud.digitalocean.com/account/api/tokens) from DigitalOcean.
- SSH key pair generated. [Generate SSH Key](https://www.digitalocean.com/docs/droplets/how-to/add-ssh-keys/to-droplet/)
- [Tailscale](https://tailscale.com/) account.
- [Tailscale Auth Key](https://login.tailscale.com/admin/authkeys) from Tailscale.
  
## Steps

### Bootstrap

```bash
$ mkdir -p dropletdev/terraform
$ cd dropletdev/terraform
$ touch main.tf
$ touch userdata.tpl
$ touch .env
$ echo 'export TF_VAR_do_token="your digital ocean token"' >> .env
$ echo 'export TF_VAR_tailscale_token="your tailscale auth token"' >> .env
$ echo 'export TF_VAR_pub_key="your ssh pub key"' >> .env
```

### Create Resources

```hcl
terraform {
  cloud {
    organization = "org"

    workspaces {
      name = "space"
    }
  }
  required_providers {
    digitalocean = {
      source = "digitalocean/digitalocean"
      version = "~> 2.0"
    }
  }
}

variable "do_token" {}
variable "pub_key" {}

provider "digitalocean" {
    token = var.do_token
}

resource "digitalocean_vpc" "net" {
  name     = "net"
  region   = "sfo3"
  ip_range = "10.1.1.0/24"
}

resource "digitalocean_ssh_key" "default" {
  name       = SSH Key"
  public_key = var.pub_key
}

resource "digitalocean_droplet" "server" {
  count     = 1
  name      = "do-server-${count.index}"
  size      = "s-1vcpu-1gb"
  image     = "ubuntu-20-04-x64"
  tags      = [ "dev" ]
  region    = digitalocean_vpc.net.region
  vpc_uuid  = digitalocean_vpc.net.id
  ssh_keys  = [digitalocean_ssh_key.default.fingerprint]
}

resource "digitalocean_project" "proj" {
  name        = "proj"
  description = "A project for the net"
  resources   = digitalocean_droplet.server.*.urn
}

output "public_ip" {
  value = digitalocean_droplet.server.*.ipv4_address
}

output "private_ip" {
  value = digitalocean_droplet.server.*.ipv4_address_private 
}
```

```bash
$ source .env
$ terraform init
$ terraform plan -out tfplan
$ terraform apply tfplan
...wait for resources to be created

$ ssh root@$(terraform output public_ip)
```

And voila, we're in the droplet. But this still requires port 22 open to the world which is lame.

### Add Tailscale Setup

Here we use cloud-init for initialization and configuration of Tailscale on newly created Droplets. By defining a `userdata.tpl` file, we can reliably configure droplets to automatically join our Tailscale network. (This is how I have things configured, but settings can be adjusted for other workflows.)

```bash
#cloud-config
---
apt:
  sources:
    tailscale.list:
      source: deb https://pkgs.tailscale.com/stable/ubuntu focal main
      keyid: 2596A99EAAB33821893C0A79458CA832957F5868
packages: 
  - tailscale
runcmd:
  - [tailscale, up, -authkey, ${tailscale_key}]
```

The cloud-init file handles 3 things, adding the Tailscale APT repository, installing the Tailscale package, and running the `tailscale up` command with the provided authentication key.

Now we can update the terraform configuration to include the user data, and recreate the droplet.

```hcl
variable "tailscale_token" {}
...

}
  ...
  user_data = templatefile("${path.module}/userdata.tpl", {
    tailscale_key = var.tailscale_token
  })
}
```

```bash
$ tailscale status
$ terraform plan -out tfplan
$ terraform apply tfplan
...wait for resources to be created
$ tailscale status